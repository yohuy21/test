<!-- 영업 2본부 call 리스트 -->
    <select id="getSalesCall2" parameterType="net.ezens.beerk.salesactivity.model.SalesCall" resultType="net.ezens.beerk.salesactivity.model.SalesCall">
    	DECLARE
		      @D_START_DATE   nvarchar(10)
		     ,@D_END_DATE   nvarchar(10)
		      SET @D_START_DATE = ( SELECT CONVERT(VARCHAR(10), DATEADD(D, -DAY(#{yyyymmdd}) + 1, #{yyyymmdd}), 112) )
		      SET @D_END_DATE   = ( SELECT CONVERT(VARCHAR(10), DATEADD(s, -1, DATEADD(mm, DATEDIFF(m, 0, #{yyyymmdd}) + 1, 0)), 112) )
		SELECT MD.CD_DEPT1
			  ,MD.NM_DEPT1
			  ,MD.CD_DEPT2
			  ,MD.NM_DEPT2
			  ,MD.CD_DEPT3
			  ,MD.NM_DEPT3
			  ,MD.TP_DEPT
			  ,MD.NO_EMP
			  ,MD.NM_KOR
			  ,MD.CD_INCOM
			  ,MD.CD_DUTY_RANK
			  ,MD.PART_MEM_CNT
			  ,ISNULL(SI.BUSINESS_CNT, 0) AS BUSINESS_CNT
			  ,ISNULL(SI.SUB_SEG_PS01_CNT, 0) AS SUB_SEG_PS01_CNT
			  ,ISNULL(SI.SUB_SEG_PS02_CNT, 0) AS SUB_SEG_PS02_CNT
			  ,ISNULL(SI.SUB_SEG_PS03_CNT, 0) AS SUB_SEG_PS03_CNT
			  ,ISNULL(SI.SUB_SEG_PS04_CNT, 0) AS SUB_SEG_PS04_CNT
			  ,ISNULL(ROUND(SI.SUB_SEG_PS01_CNT / PART_MEM_CNT / 21.0, 1), 0) AS SUB_SEG_PS01_DAY_AVG
			  ,ISNULL(ROUND(SI.SUB_SEG_PS02_CNT / PART_MEM_CNT / 21.0, 1), 0) AS SUB_SEG_PS02_DAY_AVG
			  ,ISNULL(ROUND(SI.SUB_SEG_PS03_CNT / PART_MEM_CNT / 21.0, 1), 0) AS SUB_SEG_PS03_DAY_AVG
			  ,ISNULL(ROUND(SI.SUB_SEG_PS04_CNT / PART_MEM_CNT / 21.0, 1), 0) AS SUB_SEG_PS04_DAY_AVG
			  ,ISNULL(SI.RS_ALL_CNT, 0) AS RS_ALL_CNT
		  FROM (SELECT MD1.CD_COMPANY
					  ,MD1.CD_DEPT AS CD_DEPT1
					  ,MD1.NM_DEPT AS NM_DEPT1
					  ,MD2.CD_DEPT AS CD_DEPT2
					  ,MD2.NM_DEPT AS NM_DEPT2
					  ,'' AS CD_DEPT3
					  ,'' AS NM_DEPT3
					  ,MD2.TP_DEPT
					  ,ME.NO_EMP
					  ,ME.NM_KOR
					  ,ME.CD_INCOM
					  ,ME.CD_DUTY_RANK
					  ,(SELECT COUNT(*) FROM MA_EMP WHERE CD_COMPANY = #{cdCompany} AND CD_DEPT = MD2.CD_DEPT AND CD_INCOM != '099') AS PART_MEM_CNT
				  FROM MA_DEPT MD1 
				  LEFT OUTER JOIN MA_DEPT MD2 ON MD1.CD_DEPT = MD2.H_DEPT AND MD1.CD_COMPANY = MD2.CD_COMPANY 
				  LEFT OUTER JOIN MA_EMP ME ON MD2.CD_DEPT = ME.CD_DEPT AND MD2.CD_COMPANY = ME.CD_COMPANY 
				
				UNION ALL
				
				SELECT MD1.CD_COMPANY
					  ,MD1.CD_DEPT AS CD_DEPT1
					  ,MD1.NM_DEPT AS NM_DEPT1
					  ,MD2.CD_DEPT AS CD_DEPT2
					  ,MD2.NM_DEPT AS NM_DEPT2
					  ,MD3.CD_DEPT AS CD_DEPT3
					  ,MD3.NM_DEPT AS NM_DEPT3
					  ,MD3.TP_DEPT, ME.NO_EMP
					  ,ME.NM_KOR
					  ,ME.CD_INCOM
					  ,ME.CD_DUTY_RANK
					  ,(SELECT COUNT(*) FROM MA_EMP WHERE CD_COMPANY = #{cdCompany} AND CD_DEPT = MD3.CD_DEPT AND CD_INCOM != '099') AS PART_MEM_CNT
				  FROM MA_DEPT MD1 
				  LEFT OUTER JOIN MA_DEPT MD2 ON MD1.CD_DEPT = MD2.H_DEPT AND MD1.CD_COMPANY = MD2.CD_COMPANY
				 INNER JOIN MA_DEPT MD3 ON MD2.CD_DEPT = MD3.H_DEPT AND MD2.CD_COMPANY = MD3.CD_COMPANY 
				  LEFT OUTER JOIN MA_EMP ME ON MD3.CD_DEPT = ME.CD_DEPT AND MD3.CD_COMPANY = ME.CD_COMPANY
		) MD LEFT OUTER JOIN (SELECT SI.NO_EMP
							,(SELECT COUNT(DISTINCT YYYY+MM+DD) FROM SA_Z_BEERK_SALES_INFO WHERE CD_COMPANY = #{cdCompany} AND (AIM_TYPE = '04' OR AIM_TYPE = '05') AND NO_EMP = SI.NO_EMP AND YYYY+MM+DD BETWEEN @D_START_DATE AND @D_END_DATE) AS BUSINESS_CNT
							,COUNT(CASE WHEN MPA.STORE_TYPE3 = 'PS01' THEN 1 END) AS SUB_SEG_PS01_CNT
							,COUNT(CASE WHEN MPA.STORE_TYPE3 = 'PS02' THEN 1 END) AS SUB_SEG_PS02_CNT
							,COUNT(CASE WHEN MPA.STORE_TYPE3 = 'PS03' THEN 1 END) AS SUB_SEG_PS03_CNT
							,COUNT(CASE WHEN MPA.STORE_TYPE3 = 'PS04' THEN 1 END) AS SUB_SEG_PS04_CNT
							,(SELECT COUNT(CD_RETAIL) FROM SA_Z_BEERK_RETAIL_STORE WHERE CD_COMPANY = #{cdCompany} AND NO_EMP = SI.NO_EMP) AS RS_ALL_CNT
						  FROM SA_Z_BEERK_SALES_INFO SI 
						  LEFT OUTER JOIN SA_Z_BEERK_RETAIL_STORE RS ON SI.CD_RETAIL = RS.CD_RETAIL AND SI.CD_COMPANY = RS.CD_COMPANY AND RS.DEL_YN = 'N'
						  LEFT OUTER JOIN SA_Z_BEERK_MA_PARTNER_ADD MPA ON SI.CD_PARTNER = MPA.CD_PARTNER AND SI.CD_COMPANY = MPA.CD_COMPANY
						 WHERE SI.CD_COMPANY = #{cdCompany}
						   AND YYYY+MM+DD BETWEEN @D_START_DATE AND @D_END_DATE
						 GROUP BY SI.NO_EMP) SI ON MD.NO_EMP = SI.NO_EMP
		 <!-- WHERE MD.CD_DEPT1 = #{cdDept1} -->
		 WHERE (MD.CD_DEPT1 = #{cdDept1} OR (MD.CD_DEPT2 = #{cdDept1} AND MD.CD_DUTY_RANK = '120')) 
		   AND MD.CD_COMPANY = #{cdCompany}
		   AND MD.CD_INCOM != '099'
		<if test="noEmp != null and noEmp !=''">
		   AND MD.NO_EMP = #{noEmp}
		</if>
		<if test="cdDept != null and cdDept !=''">
		   AND (CD_DEPT1 IN (${cdDept}) OR CD_DEPT2 IN (${cdDept}) OR CD_DEPT3 IN (${cdDept}))
		</if>
		 ORDER BY MD.CD_DEPT1, MD.CD_DEPT2, MD.CD_DEPT3
    </select>